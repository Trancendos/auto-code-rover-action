name: 'AutoCodeRover Action'
description: 'Run AutoCodeRover for automatic program repair'
inputs:
  bug_id:
    description: 'Bug ID to repair'
    required: true
runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    
    - name: Install AutoCodeRover
      run: |
        echo "::group::Install AutoCodeRover"
        python -m pip install --upgrade pip
        pip install auto-code-rover
        echo "::endgroup::"
      shell: bash

    - name: Run AutoCodeRover
      env:
        BUG_ID: ${{ inputs.bug_id }}
      run: |
        echo "ðŸš€ Starting repair for bug: $BUG_ID"
        auto-code-rover repair --bug-id "$BUG_ID"
      shell: bash

    - name: List repair results
      run: |
        if [ -d "repair_results" ]; then
           ls -R repair_results/
           {
             echo "## ðŸ› ï¸ Repair Results"
             echo ""
             echo "The following results were generated:"
             echo '```'
             ls -R repair_results/
             echo '```'
           } >> "$GITHUB_STEP_SUMMARY"

           find repair_results -type f \( -name "*.patch" -o -name "*.diff" \) | while read -r patch_file; do
             filename=$(basename "$patch_file")
             {
               echo "<details>"
               echo "<summary>Preview: $filename</summary>"
               echo ""
               echo '```diff'
               cat "$patch_file"
               echo '```'
               echo ""
               echo "</details>"
             } >> "$GITHUB_STEP_SUMMARY"
           done
        else
           echo "::error::repair_results directory not found"
           echo "âš ï¸ No results directory found." >> "$GITHUB_STEP_SUMMARY"
           exit 1
        fi
      shell: bash